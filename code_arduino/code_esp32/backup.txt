#include <Arduino.h>

#define USE_SERIAL Serial

//librairie pour le wifi
#include <WiFi.h>
#include <esp_wifi.h>

//librairie pour communication en uart
#include <HardwareSerial.h>

HardwareSerial MySerial(2);
const int UART2_Rx = 16;
const int UART2_Tx = 17;

/* prototype des fonctions */
int scan_network(void);

/* setup et loop */
void setup(void)
{
  Serial.begin(115200);

  MySerial.begin(9600, SERIAL_8N1, UART2_Rx, UART2_Tx);

  /*setup lora*/
  MySerial.println("AT+DR=EU868");
  delay(5000);
  while (MySerial.available() >= 1)
  {
    Serial.printf("%c", MySerial.read());
  }

  MySerial.println("AT+ID=DevEUI,70B3D57ED0073496");
  delay(5000);
  while (MySerial.available() >= 1)
  {
    Serial.printf("%c", MySerial.read());
  }

  MySerial.println("AT+ID=AppEUI,0000000000000000");
  delay(5000);
  while (MySerial.available() >= 1)
  {
    Serial.printf("%c", MySerial.read());
  }

  MySerial.println("AT+KEY=APPKEY,6B6C025304DA03A05C84891F66E987E1");
  delay(5000);
  while (MySerial.available() >= 1)
  {
    Serial.printf("%c", MySerial.read());
  }

  MySerial.println("AT+DR=DR3");
  delay(5000);
  while (MySerial.available() >= 1)
  {
    Serial.printf("%c", MySerial.read());
  }

  MySerial.println("AT+JOIN");
  delay(15000);
  while (MySerial.available() >= 1)
  {
    Serial.printf("%c", MySerial.read());
  }
  /*__________*/
  
  WiFi.mode(WIFI_STA);
}

void loop()
{
  scan_network();

  delay(5000);

  while (MySerial.available() >= 1)
  {
    Serial.printf("%c", MySerial.read());
  }
}

/* fonctions */

/*Return -1 for Errors, 0 for no network found and the number of found network else*/
int scan_network(void)
{
  Serial.println("Scanning networks ...");
  int nbSSID = WiFi.scanNetworks();
  if(nbSSID < 0)
  {
    Serial.println("Failed to scan for networks.");
    return -1;
  }else if(!nbSSID)
  {
    Serial.println("No network detected");
    return 0;
  }

  char msg[25] = {0};
  //sprintf(msg, "AT+MSG=");

  int limit = 15;

  for (int i = 0; i < ((nbSSID < limit) ? nbSSID : limit); i++)
  {
    Serial.printf("%d- %s | Addr MAC : %02x:%02x:%02x:%02x:%02x:%02x | signal strength : %ld dBm\n", i, WiFi.SSID(i), *WiFi.BSSID(i), *(WiFi.BSSID(i) + 1), *(WiFi.BSSID(i) + 2), *(WiFi.BSSID(i) + 3), *(WiFi.BSSID(i) + 4), *(WiFi.BSSID(i) + 5), WiFi.RSSI(i));
    sprintf(msg, "AT+MSG=%02x%02x%02x%02x%02x%02x.%04ld", *WiFi.BSSID(i), *(WiFi.BSSID(i) + 1), *(WiFi.BSSID(i) + 2), *(WiFi.BSSID(i) + 3), *(WiFi.BSSID(i) + 4), *(WiFi.BSSID(i) + 5), WiFi.RSSI(i));
    MySerial.println(msg);
    delay(10000);
    while (MySerial.available() >= 1)
    {
      Serial.printf("%c", MySerial.read());
    }
  }

  //Serial.print("\n\nDone\n\n");
  //Serial.println(nbSSID);
  
  return nbSSID;
}